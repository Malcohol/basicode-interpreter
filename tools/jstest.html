<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <style>
        .screen-wrapper {
            font-size: 1rem;
            width: 79ch;
            padding:0;
            display:table;
            padding: 0.5rem 0.5rem 0.5rem 0.5rem;
            border-radius: 0.8rem;
            border: 1px solid lightblue;
            text-align: center;
            background-color: white;
        }
        #input, #output {
            text-align: left;
            vertical-align: middle;
            font-family: monospace;
            font-size: 1rem;
            outline: none;
            overflow: hidden;
            border: 0;
            padding: 0;
            margin: auto;
            transform: scaleX(2);
            background-color: lightblue;
        }
        #input {
            width: 40ch;
            height: 2rem;
            resize: none;
        }
        #output {
            width: 40ch;
            height: 24rem;
        }
    </style>

    <script src="basicode.js"></script>
</head>

<body>
    <div class="screen-wrapper"><textarea id="input"></textarea></div>
    <button id="get_output">Test</button>
    <div class="screen-wrapper">
        <pre id="output">Output here</pre>
    </div>

    <script>
        "use strict";

        document.getElementById("get_output").onclick = function () {
            // setup
            var app = new BasicodeApp();
            var iface = app.iface;
            //var state = app.state;
            var parser = app.parser;

            // screen + input test
            var input = iface.read();
            iface.clear();
            iface.write('you typed: ' + input + '\n');
            iface.write('We can write <br>\n');
            iface.write('We can write \\\n\n');

            // variable test
            var vars = new Variables();
            vars.assign(10, 'A$', []);
            vars.assign(11, 'A$', []);
            vars.allocate('B$', [10]);
            vars.assign(12, 'B$', [1]);
            vars.allocate('C', [100,100]);
            vars.assign(12, 'C', [1,100]);
            //TODO: implement type mismatch checks
            iface.write((vars.retrieve('A$', []) === 11) + ' ');
            iface.write((vars.retrieve('B$', [1]) === 12) + ' ');
            iface.write((vars.retrieve('C', [1, 100]) === 12) + ' ');
            iface.write((vars.retrieve('C', [1, 99]) === 0) + '\n');

            // data reader test
            var data = new Data();
            data.store([1,2,3,4,5]);
            iface.write(((data.read() == 1) && (data.read() == 2)) + '\n');
            data.clear();

            // evaluate test
            var node = new Node(function(a, b) { return a+b; }, [1, 5]);
            var node2 = new Node(function(a, b) { return a*b; }, [node, 5]);
            iface.write((node2.evaluate() == 30) + '\n');

            // expression parser test
            var expr_list = [
                new tokenSeparator('('),
                new tokenLiteral(3), SYMBOLS['+'](),
                new tokenLiteral(4), SYMBOLS['*'](), new tokenLiteral(2),
                new tokenSeparator(')'),
                SYMBOLS['/'](), new tokenLiteral(5),
            ];
            var ast = parser.parseExpression(expr_list);
            iface.write((ast.evaluate() == 2.2) + '\n');

            // lexer tests
            iface.write((parser.parseExpression(tokenise('1-2')).evaluate() == -1) + ' ');
            iface.write((parser.parseExpression(tokenise('-1')).evaluate() == -1) + ' ');
            iface.write((parser.parseExpression(tokenise('.5')).evaluate() == 0.5) + ' ');
            iface.write((parser.parseExpression(tokenise('-.5')).evaluate() == -0.5) + ' ');
            iface.write((parser.parseExpression(tokenise('1.2e2')).evaluate() == 120) + ' ');
            iface.write((parser.parseExpression(tokenise('1.2e-2')).evaluate() == 0.012) + '\n');

            // expression lexer+parser tests
            iface.write((parser.parseExpression(tokenise('((1=1)) OR (1=0)')).evaluate() == true) + ' ');
            iface.write((parser.parseExpression(tokenise('((1=1)) AND (1=0)')).evaluate() == false) + ' ');
            iface.write((parser.parseExpression(tokenise('NOT 0')).evaluate() == true) + ' ');
            iface.write((parser.parseExpression(tokenise('cos(0)')).evaluate() == 1) + ' ');
            iface.write((parser.parseExpression(tokenise('val("1e+2")')).evaluate() == 100) + ' ');
            iface.write((parser.parseExpression(tokenise('val("1e-2")')).evaluate() == 0.01) + ' ');

            // statement tests
            parser.parseLine(tokenise('LET D=1:LET E=2\n')).evaluate();
            iface.write((parser.parseExpression(tokenise('E')).evaluate() == 2) + ' ');
            parser.parseLine(tokenise('LET F=D+E\n')).evaluate();
            iface.write((parser.parseExpression(tokenise('F')).evaluate() == 3) + '\n');
            parser.parseLine(tokenise('PRINT "print test: ";D;:print E-3;F:print f\n')).evaluate();
            parser.parseLine(tokenise('PRINT "TAB test: ";1;TAB(20);2;\n')).evaluate();
            // we're allowing empty lines; not necessary
            var prog = parser.parseProgram(tokenise('1010 READG,H,I, J\n1020 PRINTJ\n 1030 :RESTORE: READ J: PRINT J\n 1035\n 1040 DATA67,68,69,70\n1050 :\n1060 PRINT"program done"'))
            prog.tree.evaluate();
            prog = parser.parseProgram(tokenise('1010 DIMZ(10)\n1020 Z(9)=9\n1030 PRINT Z(9)\n'))
            prog.tree.evaluate();

            // REM and GOTO test
            prog = parser.parseProgram(tokenise([
                '1000 A=2:REM test program',
                '1010 GOTO 1030',
                '1020 PRINT"this should not be visible"; A: REM ignore this',
                '1030 GOTO 950',
                '1040 PRINT "ignore me"',
                '1050 :',
                '30000 REM BASICODE test program: ',
                '30020 REM a program that tests REMs',
            ].join('\n')));
            prog.tree.root = true;
            prog.tree.evaluate();
            iface.write('"'+prog.title+'"\n');
            iface.write(prog.description);

            prog = parser.parseProgram(tokenise([
                '1000 A=2:REM test program 2',
                '1010 B=5: GOSUB 10000',
                '1020 B=6: GOSUB 10000',
                '1025 B=7: GOSUB 10000',
                '1030 B=7: GOTO 950',
                '10000 PRINT B',
                '10010 RETURN',
                '',
            ].join('\n')));
            prog.tree.root = true;
            prog.tree.evaluate();

            prog = parser.parseProgram(tokenise([
                '1000 A=2:REM test program 2',
                '1010 B=1: GOTO 1030: B=600',
                '1020 B=1000',
                '1030 PRINT B: GOTO 950',
                '',
            ].join('\n')));
            prog.tree.root = true;
            prog.tree.evaluate();


            var expr_str = input;
            if (expr_str.length) {
                expr_list = tokenise(expr_str);
                var str2 = '';
                for (var i=0; i < expr_list.length; ++i) {
                    str2 += expr_list[i].token_type +' ' + expr_list[i].payload+',';
                }
                ast = parser.parseExpression(expr_list);

                var rem = 'remainder of expr: ';
                for (var i=0; i < expr_list.length; ++i)
                    rem += expr_list[i].payload;
                console.log(rem);

                iface.write('evaluate ' + expr_str + ' = ' + ast.evaluate() + '\n');
            }

            iface.write('done');
        };
    </script>
</body>
</html>
